# Global definitions for the keepalived instance
global_defs {
    router_id LBR-MASTER  # A unique identifier for this node
    # notification_email { ... } # Optional email notifications
}

# Health check script to verify the local load balancer (e.g., HAProxy) is running
vrrp_script check_haproxy {
    script "killall -0 haproxy" # Checks if haproxy process is running
    interval 2                 # Run every 2 seconds
    weight 20                  # Add weight to priority if script passes
    fall 2                     # Fail after 2 consecutive failures
    rise 2                     # Pass after 2 consecutive successes
}

# VRRP Instance for the OpenShift API VIP
vrrp_instance VI_OS_API {
    state BACKUP             # Initial state
    interface ens33          # The network interface connected to the OCP network
    virtual_router_id 51     # Unique VRRP ID for the API instance (1-255)
    priority 100             # Priority (higher wins election)
    advert_int 1             # Advertisement interval in seconds
    authentication {
        auth_type PASS       # Simple password authentication
        auth_pass apipass    # Must match on all load balancers
    }
    virtual_ipaddress {
        10.151.87.9/24 dev ens33       # The OpenShift API VIP (api.<cluster-name>.<base-domain>)
        10.151.87.10/24 dev ens33     # The OpenShift Ingress VIP (*.apps<cluster-name>.<base-domain>)  
    }
    track_script {
        check_haproxy        # Track the health script
    }
}

